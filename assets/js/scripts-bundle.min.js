!function(){"use strict";var e=angular.module("meovn",["cfp.hotkeys","ngAnimate","toastr","firebase","facebook","CopyToClipboard","angular-web-notification","ngAudio"]);e.config(["FacebookProvider",function(e){e.init("1085772744867580")}]),e.config(function(e,t){t.otherwise("/home"),e.state("home",{url:"/home",controller:"homeCtrl",templateUrl:"templates/home.html"})}),e.controller("OrdersController",function(e,t,r,n,a,o,s,i,d,u,c){e.audio=c.load("assets/sounds/click.mp3"),e.clickSound=c.load("assets/sounds/button-2.mp3"),e.getOrderSound=c.load("assets/sounds/click.mp3"),e.releaseOrderSound=c.load("assets/sounds/button-4.mp3"),e.popupSound=c.load("assets/sounds/new-order.mp3");var l="EAAPbgSrDvvwBAE83TW0ZCCm83YuFXjaQmyd7UQZC9hHhaumkN8aiscrr0hxvlRZAeVae7HDpY1vv3aIzPZAH3O6QtHipfooGJzZBH1WioeKiUZAZC2pkuUJRoAMNvzh5RtQBHiRzfrG12e7nzYRl4E1h7kTbXRW1VsZD";e.graphPage=function(t){e.isPageBusy=!0,i.api("/"+t+"?access_token="+l,function(t){e.currentPageName=t.name}),i.api("/"+t+"/picture?access_token="+l,function(t){e.currentPageAvatar=t.data.url}).then(function(){e.isPageBusy=!1})},e.userAvatar=null,e.userLink=null,e.graphUser=function(t){i.api("/"+t+"/picture?height=100&width=100",function(t){e.userAvatar=t.data.url})},e.newAvatar=null,e.graphUserAvatar=function(t){i.api("/"+t+"/picture?height=100&width=100",function(t){t&&!t.error||alert("error!"),e.newAvatar=t.data.url})},e.graphPost=function(t,r){e.isPageBusy=!0,i.api("/"+t+"_"+r+"?access_token="+l,function(t){e.fbContent=t}).then(function(){e.isPageBusy=!1}),i.api("/"+t+"_"+r+"/attachments?access_token="+l,function(t){e.fbPhotos=[];for(var r=0;r<t.data[0].subattachments.data.length-1;r++)e.fbPhotos.push(t.data[0].subattachments.data[r].media.image.src)}).then(function(){e.isPageBusy=!1})},e.buyersAvatar=[],e.graphAllBuyersAvatar=function(){angular.forEach(e.orders,function(t,r){console.log(t.fbId),i.api("/"+t.fbId+"/picture?height=100&width=100",function(r){e.$apply(function(){t.fbId&&e.buyersAvatar.push({fbId:t.fbId,avatar:r.data.url})})})})},e.getBuyerAvatar=function(t){return e.buyersAvatar.filter(function(e){return e.fbid==t.fbid})[0]};var f=firebase.database().ref();e.orders=s(f.child("orders")),e.comments=s(f.child("comments")),e.sources=s(f.child("sources")),e.statuses=s(f.child("statuses")),e.sellers=s(f.child("members")),e.packs=s(f.child("packs")),firebase.database().ref("orders").on("value",function(e){console.log(e.val())}),e.orders.$loaded().then(function(t){e.graphAllBuyersAvatar(),e.isAsideLoading=!1,firebase.database().ref("orders").limitToLast(1).on("child_added",function(t){e.showNotify(t.val())}),console.log(e.buyersAvatar)}),e.defaultToastrConfig=angular.copy(o),e.alertTypes=["success","error","info","warning"],e.showSearchbox=!0,e.isSeaching=!1,e.searchText="",e.isPageBusy=!1,e.isAsideLoading=!0,e.isPostingComment=!1,e.activeStatus=null,e.date=new Date,e.fbContent=null,e.fbPhotos=[],e.currentPageName="",e.currentPageAvatar="",e.dateRange={},e.dateRange.startDate=new Date,e.dateRange.endDate=new Date,e.isPostExpanded=!1,e.child={},e.newDate=function(e){return new Date(e)},e.toggleExpandPost=function(){e.isPostExpanded=!e.isPostExpanded},e.currentUser=null,e.isShowAll=!1,e.getOrders=function(r,n){e.isAsideLoading=!0;t.get("/v3/getOrders").then(function(t){e.showMyOrders=!1,e.activeStatus=null,e.isShowAll=!0;for(var r=0;r<t.length;r++)fOrdersRef.child("orders").push({buyer_mobile:t[r].buyer_mobile,buyer_name:t[r].buyer_name,created_at:t[r].created_at,id:t[r].id,lock:t[r].lock,order_source_id:t[r].order_source_id,product_pack_id:t[r].product_pack_id,seller_will_call_id:t[r].seller_will_call_id||null,status_id:t[r].status_id,sticky:t[r].sticky});e.orders.page++,e.isAsideLoading=!1,e.orders.length>0&&e.active(e.orders[0])})},e.testPusher=function(){},e.isLoadingMore=!1,e.loadMoreRecords=function(){return!1},e.showAlert=function(t,r,n){var o={autoDismiss:!1,positionClass:"toast-bottom-center",type:n,timeOut:"3000",extendedTimeOut:"2000",allowHtml:!1,closeButton:!0,tapToDismiss:!0,progressBar:!1,newestOnTop:!0,maxOpened:0,preventDuplicates:!1,preventOpenDuplicates:!1,title:t,msg:r};angular.extend(e.defaultToastrConfig,o),a[o.type](o.msg,o.title,e.defaultToastrConfig)},e.$on("$destroy",function(){angular.extend(o,e.defaultToastrConfig)}),e.showMyOrders=!1,e.toggleShowMyOrders=function(){e.showMyOrders=!e.showMyOrders},e.getMyOrders=function(){e.isShowAll=!1,e.isAsideLoading=!0;t.get("v3/getMyOrders/?page=1").then(function(t){e.showMyOrders=!0,e.activeStatus=null,e.orders=s(fOrdersRef);for(var r=0;r<t.length;r++)e.orders.$add(t[r]);e.orders.page++,e.isAsideLoading=!1,e.orders.length>0&&e.active(e.orders[0])})},e.getOrderByUid=function(t){return e.orders.filter(function(e){return e.id==t})[0]},e.addToFavourite=function(t,r){t.stopPropagation(),r.seller_will_call_id?e.showAlert("","Oops! This Order has belonged to "+e.findUser(r.seller_will_call_id).last_name,"error"):(r.seller_will_call_id=CURRENT_USER_ID,e.orders.$save(r),e.getOrderSound.play())},e.userCanReleaseOrChangeStatus=function(t){return 1==e.currentUser.is_admin||e.currentUser.id==t.seller_will_call_id},e.releaseOrder=function(t,r){if(t.stopPropagation(),!e.userCanReleaseOrChangeStatus)return!1;r.seller_will_call_id=null,e.orders.$save(r),e.releaseOrderSound.play()},e.resetSearch=function(){e.searchText=""},e.toggleShowAll=function(){e.activeStatus=null,e.showMyOrders=!1,e.searchText=""},e.toggleActiveStatus=function(t){e.activeStatus!=t?e.activeStatus=t:e.activeStatus=null},e.GetOrdersByStatus=function(r){e.isShowAll=!1,e.isAsideLoading=!0;var n="v3/getOrdersByStatus/"+r.id+"?page=1";t.get(n).then(function(t){e.showMyOrders=!1,e.orders=s(fOrdersRef);for(var r=0;r<t.length;r++)e.orders.$add(t[r]);e.orders.page++,e.isAsideLoading=!1,e.orders.length>0&&e.active(e.orders[0])})},e.getPageIdFromOrder=function(t){var r=n("filter")(e.sources,{id:t.order_source_id},!0);return r.length?r[0].page_id:null},e.getPostIdFromOrder=function(t){var r=n("filter")(e.packs,{id:t.product_pack_id},!0);return r.length?r[0].post_id:null},e.active=function(t,r){e.isPageBusy=!0,e.clickSound.play(),e.isPostExpanded=!1,e.graphUser(t.fbId),e.fbContent=[],e.fbContent.message="Fetching Post content from Facebook...",e.fbPhotos=[],e.currentPageName="Fetching Page name from Facebook...",e.currentPageAvatar="",e.orders.active=t,e.graphPage(e.getPageIdFromOrder(t)),e.graphPost(e.getPageIdFromOrder(t),e.getPostIdFromOrder(t))},e.getComments=function(r){var n="/v3/getComments/"+r.id;e.isPageBusy=!0,t.get(n).then(function(t){if(t.length>0)for(var r=0;r<t.length;r++){var n=e.findUser(t[r].user_id);t[r].id,t[r].content,t[r].created_at,t[r].type,t[r].status_id}e.isPageBusy=!1})},e.findUser=function(t){var r=n("filter")(e.users,{id:t},!0);return r.length?r[0]:null},e.getStatusById=function(t){var r=n("filter")(e.ordersStatuses,{id:t},!0);return r.length?r[0]:null},e.getOrderStatusForOrder=function(t){if(t)for(var r=0;r<e.ordersStatuses.length;r++)if(t.status_id==e.ordersStatuses[r].id)return e.ordersStatuses[r].display_type},e.filterOrdersByStatus=function(e){firebase.database().ref().child("orders").orderByChild("status_id").equalTo(e.id).once("value",function(t){console.log("status id: "+e.id),t.forEach(function(e){var t=e.val();console.log(t)})})},e.commentData={},e.loading=!1,e.submitComment=function(t){if(!e.commentData.content)return!1;var r={id:firebase.database().ref().child("comments").push().key,order_id:t.id,content:e.commentData.content,created_at:Date.now(),type:0,status_id:0,user:e.findUser(CURRENT_USER_ID)};firebase.database().ref().child("comments").push(r),e.commentData={}},e.saveComment=function(e,r){return t({method:"POST",url:"/v3/comments/post/"+r,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(e)})},e.removeComment=function(t){var r=e.commentList.indexOf(t);e.commentList.splice(r,1)},e.getCommentById=function(t){var r=n("filter")(e.commentList,{id:t},!0);return r.length?r[0]:null},e.getDeleteComment=function(e){return t.delete("v3/deleteComment/"+e)},e.deleteComment=function(t){void 0!=t.id&&e.comments.$remove(t)},e.changeStatus=function(e,r){if(!e)return!1;var n="v3/changeOrderStatus/"+e.id+"/"+r;return t.post(n,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"}})},e.updateStatus=function(t,r,n){if(e.clickSound.play(),!e.userCanReleaseOrChangeStatus(t))return e.showAlert("","Oops! Not allowed to change the order status of others.","error"),!1;var a=angular.element(r.target).attr("data-status-id");t.status_id=a,e.orders.$save(t),e.orders.active=t;var o={id:firebase.database().ref().child("comments").push().key,order_id:t.id,content:"",created_at:Date.now(),type:1,status_id:n.id,user:e.findUser(CURRENT_USER_ID)};firebase.database().ref().child("comments").push(o),e.commentData={}},e.quickUpdateStatus=function(t){if(!e.orders.active)return e.showAlert("","Oops! Please select an Order befor perform this action.","error"),!1;e.changeStatus(e.orders.active,t).then(function(r){for(var n=e.orders.length-1;n>=0;n--)e.orders[n].id==e.orders.active.id&&(e.orders[n].status_id=t)})},e.saveStatusComment=function(e,r){if(!r)return!1;var n="/v3/comments/postStatus/"+r.id;return t.post(n,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:e})},e.querySearch={text:""},e.resetSearch=function(){e.querySearch={}},e.searchQueryChange=function(){e.querySearch.text&&0!=e.querySearch.text.length||e.resetSearch()},e.orderListBeforeSearch={orders:{},active:null},e.toggleShowSearchBox=function(){e.showSearchbox=!e.showSearchbox},r.add({combo:"shift+c",description:"Chốt nhanh đơn hàng",callback:function(){e.quickUpdateStatus(6)}}),r.add({combo:"shift+m",description:"Hiện thông tin cá nhân của tôi",callback:function(){e.child.toggleShowMeExpand()}});var h=function(e){var t,r,n,a;return t=g(e.order_source_id),r=m(e.product_pack_id),n=p(e.status_id),a=v(e.seller_will_call_id),"Page:\t\t\t"+t[0].source_name+"\nGói sp:\t\t\t"+r[0].short_title+"/"+r[0].price+"K\nTrạng thái:\t\t"+n[0].name+"\nNgười gọi:\t\t"+(a?a[0].last_name:"Chưa có")},g=function(e){if(!e)return null;var t=[];return f.child("sources").orderByChild("id").equalTo(e).on("value",function(e){e.forEach(function(e){var r=e.val();t.push(r)})}),t},p=function(e){if(console.log(e),!e)return null;var t=[];return f.child("statuses").orderByChild("id").equalTo(e).on("value",function(e){e.forEach(function(e){var r=e.val();t.push(r)})}),t},m=function(e){if(!e)return null;var t=[];return f.child("packs").orderByChild("id").equalTo(e).on("value",function(e){e.forEach(function(e){var r=e.val();t.push(r)})}),t},v=function(e){if(!e)return null;var t=[];return f.child("members").orderByChild("id").equalTo(e).on("value",function(e){e.forEach(function(e){var r=e.val();t.push(r)})}),t};e.clibboardCoppyLink=function(t){var r=h(e.orders.active);d.copy(r).then(function(){e.showAlert("","Order has been copied. Press Ctrl+V to paste.","info")})},e.showNotify=function(t){e.graphUserAvatar(t.fbId);var r=t&&t.buyer_name?t.buyer_name+t.buyer_mobile:"No name";u.showNotification("New Order Notification",{body:r,icon:e.newAvatar,onClick:function(){e.active(t,null)},autoClose:5e3},function(e,t){e?window.alert("Unable to show notification: "+e.message):(console.log("Notification Shown."),setTimeout(function(){console.log("Hiding notification...."),t()},5e3))})}}).directive("myEnter",function(){return function(e,t,r){e.isPageBusy=!0,t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(r.myEnter),e.submitComment(e.orders.active),e.isPageBusy=!1}),t.preventDefault())})}}).filter("my_filter",function(){return function(e,t){return e.filter(function(e){if(t.searchText.length>0)return-1!==e.buyer_mobile.indexOf(t.searchText)||-1!==e.buyer_name.toUpperCase().indexOf(t.searchText.toUpperCase());Date.now(),Date.now();return t.showMyOrders&&t.activeStatus?e.seller_will_call_id==t.currentUser.id&&e.status_id==t.activeStatus.id:t.activeStatus?e.status_id==t.activeStatus.id:t.showMyOrders?e.seller_will_call_id==t.currentUser.id:e.created_at<=Date.now()})}}),e.controller("MembersController",function(e,t,r,n){e.showPasswordEditBox=!1,e.showMeExpand=!1,e.$parent.child=e,e.toggleShowPasswordEditBox=function(){e.showPasswordEditBox=!e.showPasswordEditBox},e.toggleShowMeExpand=function(){e.showMeExpand=!e.showMeExpand},e.submitPassword=function(t,r){e.changePassword(t,r).then(function(t){e.showPasswordEditBox=!1,n.location.href="/logout"})},e.changePassword=function(e,r){if(e){var n=$("input.newPassword").val();if(!(n.length<8)){var a="v3/changePassword/"+e.id;return t.post(a,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:n})}alert("Nhập mật khẩu tổi thiểu 8 ký tự!")}}})}();