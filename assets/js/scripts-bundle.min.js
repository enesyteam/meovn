var meovn=angular.module("meovn",["ui.router","cfp.hotkeys","ngAnimate","toastr","firebase","facebook","CopyToClipboard","angular-web-notification","ngAudio"]).config(["$stateProvider","$urlRouterProvider","FacebookProvider",function(e,t,r){t.otherwise("/"),e.state("home",{url:"/",controller:"OrdersController",templateUrl:"/templates/home.html"}).state("auth",{url:"/auth",controller:"AuthController",templateUrl:"/templates/auth.html"});r.init("1085772744867580")}]);meovn.controller("AuthController",["$scope","$http","hotkeys","$filter","toastr","toastrConfig","$firebaseArray","Facebook","$copyToClipboard","webNotification","ngAudio",function(e,t,r,a,o,n,s,i,u,l,c){e.email="",e.password="";document.getElementById("btnSignin");var d=firebase.auth();e.signIn=function(t){t.preventDefault(),console.log(e.email+e.password),d.signInWithEmailAndPassword(e.email,e.password).catch(console.log(t.message))},firebase.auth().onAuthStateChanged(function(e){e?(console.log(e),window.location="/"):console.log("You are not loged in!")})}]),meovn.controller("MembersController",["$scope","$http","$filter","$window",function(e,t,r,a){e.showPasswordEditBox=!1,e.showMeExpand=!1,e.$parent.child=e,e.toggleShowPasswordEditBox=function(){e.showPasswordEditBox=!e.showPasswordEditBox},e.toggleShowMeExpand=function(){e.showMeExpand=!e.showMeExpand},e.submitPassword=function(t,r){e.changePassword(t,r).then(function(t){e.showPasswordEditBox=!1,a.location.href="/logout"})},e.changePassword=function(e,r){if(e){var a=$("input.newPassword").val();if(!(a.length<8)){var o="v3/changePassword/"+e.id;return t.post(o,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:a})}alert("Nhập mật khẩu tổi thiểu 8 ký tự!")}}}]),meovn.controller("OrdersController",["$scope","$http","hotkeys","$filter","toastr","toastrConfig","$firebaseArray","Facebook","$copyToClipboard","webNotification","ngAudio",function(e,t,r,a,o,n,s,i,u,l,c){e.audio=c.load("assets/sounds/click.mp3"),e.clickSound=c.load("assets/sounds/button-2.mp3"),e.getOrderSound=c.load("assets/sounds/click.mp3"),e.releaseOrderSound=c.load("assets/sounds/button-4.mp3"),e.popupSound=c.load("assets/sounds/new-order.mp3");var d="EAAPbgSrDvvwBAE83TW0ZCCm83YuFXjaQmyd7UQZC9hHhaumkN8aiscrr0hxvlRZAeVae7HDpY1vv3aIzPZAH3O6QtHipfooGJzZBH1WioeKiUZAZC2pkuUJRoAMNvzh5RtQBHiRzfrG12e7nzYRl4E1h7kTbXRW1VsZD";e.graphPage=function(t){e.isPageBusy=!0,i.api("/"+t+"?access_token="+d,function(t){e.currentPageName=t.name}),i.api("/"+t+"/picture?access_token="+d,function(t){e.currentPageAvatar=t.data.url}).then(function(){e.isPageBusy=!1})},e.userAvatar=null,e.userLink=null,e.graphUser=function(t){i.api("/"+t+"/picture?height=100&width=100",function(t){e.userAvatar=t.data.url})},e.newAvatar=null,e.graphUserAvatar=function(t){i.api("/"+t+"/picture?height=100&width=100",function(t){t&&!t.error||alert("error!"),e.newAvatar=t.data.url})},e.graphPost=function(t,r){e.isPageBusy=!0,i.api("/"+t+"_"+r+"?access_token="+d,function(t){e.fbContent=t}).then(function(){e.isPageBusy=!1}),i.api("/"+t+"_"+r+"/attachments?access_token="+d,function(t){e.fbPhotos=[];for(var r=0;r<t.data[0].subattachments.data.length-1;r++)e.fbPhotos.push(t.data[0].subattachments.data[r].media.image.src)}).then(function(){e.isPageBusy=!1})},e.buyersAvatar=[],firebase.auth().onAuthStateChanged(function(e){e||(window.location="/#/auth")});var f=firebase.database().ref();e.orders=s(f.child("orders")),e.comments=s(f.child("comments")),e.sources=s(f.child("sources")),e.statuses=s(f.child("statuses")),e.sellers=s(f.child("members")),e.packs=s(f.child("packs")),e.orders.$loaded().then(function(t){e.isAsideLoading=!1,firebase.database().ref("orders").limitToLast(1).on("child_added",function(t){e.showNotify(t.val())}),e.buyersAvatar=[],angular.forEach(t,function(t,r){i.api("/"+t.fbId+"/picture?height=100&width=100",function(r){t.fbId&&e.buyersAvatar.push({fbId:t.fbId,avatar:r.data.url})})})}),e.getBuyerAvatar=function(t){return a("filter")(e.buyersAvatar,{fbId:t.fbId}).avatar},e.defaultToastrConfig=angular.copy(n),e.alertTypes=["success","error","info","warning"],e.showSearchbox=!0,e.isSeaching=!1,e.searchText="",e.isPageBusy=!1,e.isAsideLoading=!0,e.isPostingComment=!1,e.activeStatus=null,e.date=new Date,e.fbContent=null,e.fbPhotos=[],e.currentPageName="",e.currentPageAvatar="",e.dateRange={},e.dateRange.startDate=new Date,e.dateRange.endDate=new Date,e.isPostExpanded=!1,e.child={},e.signOut=function(){firebase.auth().signOut()},e.newDate=function(e){return new Date(e)},e.toggleExpandPost=function(){e.isPostExpanded=!e.isPostExpanded},e.currentUser=null;!function(){var t=[];f.child("members").orderByChild("id").equalTo(73).once("value",function(e){e.forEach(function(e){var r=e.val();t.push(r)})}),e.currentUser=t}(),e.ordersStatusesForFilter=[],e.ordersStatuses=[],e.statuses.$loaded().then(function(t){e.ordersStatusesForFilter=[],angular.forEach(e.statuses,function(t,r){1==t.active&&1==t.allow_fillter&&e.ordersStatusesForFilter.push(t),1==t.active&&e.ordersStatuses.push(t)})}),console.log(e.ordersStatusesForFilter);e.isShowAll=!1,e.getOrders=function(r,a){e.isAsideLoading=!0;t.get("/v3/getOrders").then(function(t){e.showMyOrders=!1,e.activeStatus=null,e.isShowAll=!0;for(var r=0;r<t.length;r++)fOrdersRef.child("orders").push({buyer_mobile:t[r].buyer_mobile,buyer_name:t[r].buyer_name,created_at:t[r].created_at,id:t[r].id,lock:t[r].lock,order_source_id:t[r].order_source_id,product_pack_id:t[r].product_pack_id,seller_will_call_id:t[r].seller_will_call_id||null,status_id:t[r].status_id,sticky:t[r].sticky});e.orders.page++,e.isAsideLoading=!1,e.orders.length>0&&e.active(e.orders[0])})},e.showAlert=function(t,r,a){var n={autoDismiss:!1,positionClass:"toast-bottom-center",type:a,timeOut:"3000",extendedTimeOut:"2000",allowHtml:!1,closeButton:!0,tapToDismiss:!0,progressBar:!1,newestOnTop:!0,maxOpened:0,preventDuplicates:!1,preventOpenDuplicates:!1,title:t,msg:r};angular.extend(e.defaultToastrConfig,n),o[n.type](n.msg,n.title,e.defaultToastrConfig)},e.$on("$destroy",function(){angular.extend(n,e.defaultToastrConfig)}),e.showMyOrders=!1,e.toggleShowMyOrders=function(){e.showMyOrders=!e.showMyOrders},e.getOrderByUid=function(t){return e.orders.filter(function(e){return e.id==t})[0]},e.addToFavourite=function(t,r){t.stopPropagation(),r.seller_will_call_id?e.showAlert("","Oops! This Order has belonged to "+e.getSeller(r.seller_will_call_id).last_name,"error"):(r.seller_will_call_id=73,e.orders.$save(r),e.getOrderSound.play())},e.userCanReleaseOrChangeStatus=function(e){return!0},e.releaseOrder=function(t,r){if(t.stopPropagation(),!e.userCanReleaseOrChangeStatus)return!1;r.seller_will_call_id=null,e.orders.$save(r),e.releaseOrderSound.play()},e.resetSearch=function(){e.searchText=""},e.toggleShowAll=function(){e.activeStatus=null,e.showMyOrders=!1,e.searchText=""},e.toggleActiveStatus=function(t){e.activeStatus!=t?e.activeStatus=t:e.activeStatus=null},e.getPageIdFromOrder=function(t){var r=a("filter")(e.sources,{id:t.order_source_id},!0);return r.length?r[0].page_id:null},e.getPostIdFromOrder=function(t){var r=a("filter")(e.packs,{id:t.product_pack_id},!0);return r.length?r[0].post_id:null},e.active=function(t,r){e.isPageBusy=!0,e.clickSound.play(),e.isPostExpanded=!1,e.graphUser(t.fbId),e.fbContent=[],e.fbContent.message="",e.fbPhotos=[],e.currentPageName="",e.currentPageAvatar="",e.orders.active=t,e.graphPage(e.getPageIdFromOrder(t)),e.graphPost(e.getPageIdFromOrder(t),e.getPostIdFromOrder(t))},e.findUser=function(t){var r=a("filter")(e.sellers,{id:t},!0);return r.length?r[0]:null},e.getStatusById=function(t){var r=a("filter")(e.statuses,{id:t},!0);return r.length?r[0]:null},e.getOrderStatusForOrder=function(t){if(t)for(var r=0;r<e.statuses.length;r++)if(t.status_id==e.statuses[r].id)return e.statuses[r].display_type},e.filterOrdersByStatus=function(e){firebase.database().ref().child("orders").orderByChild("status_id").equalTo(e.id).once("value",function(e){e.forEach(function(e){e.val()})})},e.commentData={},e.loading=!1,e.submitComment=function(t){if(!e.commentData.content)return!1;var r={id:firebase.database().ref().child("comments").push().key,order_id:t.id,content:e.commentData.content,created_at:Date.now(),type:0,status_id:0,user:e.getSeller(73)};firebase.database().ref().child("comments").push(r),e.commentData={}},e.removeComment=function(t){var r=e.commentList.indexOf(t);e.commentList.splice(r,1)},e.getCommentById=function(t){var r=a("filter")(e.commentList,{id:t},!0);return r.length?r[0]:null},e.getDeleteComment=function(e){return t.delete("v3/deleteComment/"+e)},e.deleteComment=function(t){void 0!=t.id&&e.comments.$remove(t)},e.updateStatus=function(t,r,a){if(e.clickSound.play(),!e.userCanReleaseOrChangeStatus(t))return e.showAlert("","Oops! Not allowed to change the order status of others.","error"),!1;var o=angular.element(r.target).attr("data-status-id");t.status_id=o,e.orders.$save(t),e.orders.active=t;var n={id:firebase.database().ref().child("comments").push().key,order_id:t.id,content:"",created_at:Date.now(),type:1,status_id:a.id,user:e.getSeller(73)};firebase.database().ref().child("comments").push(n),e.commentData={}},e.quickUpdateStatus=function(t){if(!e.orders.active)return e.showAlert("","Oops! Please select an Order befor perform this action.","error"),!1;e.changeStatus(e.orders.active,t).then(function(r){for(var a=e.orders.length-1;a>=0;a--)e.orders[a].id==e.orders.active.id&&(e.orders[a].status_id=t)})},e.saveStatusComment=function(e,r){if(!r)return!1;var a="/v3/comments/postStatus/"+r.id;return t.post(a,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:e})},e.querySearch={text:""},e.resetSearch=function(){e.querySearch={}},e.searchQueryChange=function(){e.querySearch.text&&0!=e.querySearch.text.length||e.resetSearch()},e.orderListBeforeSearch={orders:{},active:null},e.toggleShowSearchBox=function(){e.showSearchbox=!e.showSearchbox},r.add({combo:"shift+c",description:"Chốt nhanh đơn hàng",callback:function(){e.quickUpdateStatus(6)}}),r.add({combo:"shift+m",description:"Hiện thông tin cá nhân của tôi",callback:function(){e.child.toggleShowMeExpand()}});var h=function(t){var r,a,o,n;return r=p(t.order_source_id),a=m(t.product_pack_id),o=g(t.status_id),n=e.getSeller(t.seller_will_call_id),"Page:\t\t\t"+r[0].source_name+"\nGói sp:\t\t\t"+a[0].short_title+"/"+a[0].price+"K\nTrạng thái:\t\t"+o[0].name+"\nNgười gọi:\t\t"+(n?n[0].last_name:"Chưa có")},p=function(e){if(!e)return null;var t=[];return f.child("sources").orderByChild("id").equalTo(e).on("value",function(e){e.forEach(function(e){var r=e.val();t.push(r)})}),t},g=function(e){if(!e)return null;var t=[];return f.child("statuses").orderByChild("id").equalTo(e).on("value",function(e){e.forEach(function(e){var r=e.val();t.push(r)})}),t},m=function(e){if(!e)return null;var t=[];return f.child("packs").orderByChild("id").equalTo(e).on("value",function(e){e.forEach(function(e){var r=e.val();t.push(r)})}),t};e.getSeller=function(e){if(!e)return null;var t=[];return f.child("members").orderByChild("id").equalTo(e).on("value",function(e){e.forEach(function(e){var r=e.val();t.push(r)})}),t[0]},e.clibboardCoppyLink=function(t){var r=h(e.orders.active);u.copy(r).then(function(){e.showAlert("","Order has been copied. Press Ctrl+V to paste.","info")})},e.showNotify=function(t){e.graphUserAvatar(t.fbId);var r=t&&t.buyer_name?t.buyer_name+t.buyer_mobile:"No name";l.showNotification("New Order Notification",{body:r,icon:e.newAvatar,onClick:function(){e.active(t,null)},autoClose:5e3},function(e,t){e?window.alert("Unable to show notification: "+e.message):(console.log("Notification Shown."),setTimeout(function(){console.log("Hiding notification...."),t()},5e3))})}}]),meovn.directive("myEnter",function(){return function(e,t,r){e.isPageBusy=!0,t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(r.myEnter),e.submitComment(e.orders.active),e.isPageBusy=!1}),t.preventDefault())})}}).filter("my_filter",function(){return function(e,t){return e.filter(function(e){if(t.searchText.length>0)return-1!==e.buyer_mobile.indexOf(t.searchText)||-1!==e.buyer_name.toUpperCase().indexOf(t.searchText.toUpperCase());Date.now(),Date.now();return t.showMyOrders&&t.activeStatus?e.seller_will_call_id==t.currentUser.id&&e.status_id==t.activeStatus.id:t.activeStatus?e.status_id==t.activeStatus.id:t.showMyOrders?e.seller_will_call_id==t.currentUser.id:e.created_at<=Date.now()})}});