var meovn=angular.module("meovn",["ui.router","cfp.hotkeys","ngAnimate","toastr","firebase","facebook","CopyToClipboard","angular-web-notification","ngAudio"]).config(["$stateProvider","$urlRouterProvider","FacebookProvider",function(e,t,n){t.otherwise("/"),e.state("home",{url:"/",controller:"OrdersController",templateUrl:"/templates/home.html"}).state("home.details",{url:"order/:id/seller=:seller",params:{id:null,seller:null},templateUrl:"templates/order-details.html"}).state("auth",{url:"/auth",controller:"AuthController",templateUrl:"/templates/auth.html"});n.init("1085772744867580")}]);meovn.service("firebaseService",["$firebaseArray","$filter",function(e,t){var n=firebase.database().ref();ordersArr=e(n.child("orders")),commentsArr=e(n.child("comments")),sourcesArr=e(n.child("sources")),statusesArr=e(n.child("statuses")),sellersArr=e(n.child("members")),packsArr=e(n.child("packs"));var r=function(){return ordersArr.$loaded()},o=function(){return sourcesArr.$loaded()},a=function(){return packsArr.$loaded()};return{init:function(){r(),o(),a()},getAllOrders:r,getOrder:function(e){return ordersArr.$getRecord(e)},updateOrder:function(e){return ordersArr.$save(e)},getAllSources:o,getAllPacks:a}}]),meovn.controller("AuthController",["$scope","$http","hotkeys","$filter","toastr","toastrConfig","$firebaseArray","Facebook","$copyToClipboard","webNotification","ngAudio",function(e,t,n,r,o,a,s,i,u,l,c){e.email="",e.password="";document.getElementById("btnSignin");var d=firebase.auth();e.signIn=function(t){t.preventDefault(),console.log(e.email+e.password),d.signInWithEmailAndPassword(e.email,e.password).catch(console.log(t.message))},firebase.auth().onAuthStateChanged(function(e){e?(console.log(e),window.location="/"):console.log("You are not loged in!")})}]),meovn.controller("MembersController",["$scope","$http","$filter","$window",function(e,t,n,r){e.showPasswordEditBox=!1,e.showMeExpand=!1,e.$parent.child=e,e.toggleShowPasswordEditBox=function(){e.showPasswordEditBox=!e.showPasswordEditBox},e.toggleShowMeExpand=function(){e.showMeExpand=!e.showMeExpand},e.submitPassword=function(t,n){e.changePassword(t,n).then(function(t){e.showPasswordEditBox=!1,r.location.href="/logout"})},e.changePassword=function(e,n){if(e){var r=$("input.newPassword").val();if(!(r.length<8)){var o="v3/changePassword/"+e.id;return t.post(o,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:r})}alert("Nhập mật khẩu tổi thiểu 8 ký tự!")}}}]),meovn.controller("OrdersController",["$scope","$http","hotkeys","$filter","$state","$stateParams","toastr","toastrConfig","$firebaseArray","Facebook","$copyToClipboard","webNotification","ngAudio","firebaseService",function(e,t,n,r,o,a,s,i,u,l,c,d,f,h){function p(t){e.isPageBusy=!0,l.api("/"+t+"?access_token="+y,function(t){e.currentPageName=t.name}),l.api("/"+t+"/picture?access_token="+y,function(t){e.currentPageAvatar=t.data.url}).then(function(){e.isPageBusy=!1})}function g(t){l.api("/"+t+"/picture?height=100&width=100",function(t){e.userAvatar=t.data.url})}function m(t,n){e.isPageBusy=!0,l.api("/"+t+"_"+n+"?access_token="+y,function(t){e.fbContent=t}).then(function(){e.isPageBusy=!1}),l.api("/"+t+"_"+n+"/attachments?access_token="+y,function(t){e.fbPhotos=[];for(var n=0;n<t.data[0].subattachments.data.length-1;n++)e.fbPhotos.push(t.data[0].subattachments.data[n].media.image.src)}).then(function(){e.isPageBusy=!1})}function b(t){var n=r("filter")(e.sources,{id:t.order_source_id},!0);return n.length?n[0].page_id:null}function v(t){var n=r("filter")(e.packs,{id:t.product_pack_id},!0);return n.length?n[0].post_id:null}function w(t){e.isPageBusy=!0,e.clickSound.play(),e.isPostExpanded=!1,g(t.fbId),e.fbContent=[],e.fbContent.message="",e.fbPhotos=[],e.currentPageName="",e.currentPageAvatar="",p(b(t)),m(b(t),v(t)),e.selectedOrder=t}e.audio=f.load("assets/sounds/click.mp3"),e.clickSound=f.load("assets/sounds/button-2.mp3"),e.getOrderSound=f.load("assets/sounds/click.mp3"),e.releaseOrderSound=f.load("assets/sounds/button-4.mp3"),e.popupSound=f.load("assets/sounds/new-order.mp3");var y="EAAPbgSrDvvwBAE83TW0ZCCm83YuFXjaQmyd7UQZC9hHhaumkN8aiscrr0hxvlRZAeVae7HDpY1vv3aIzPZAH3O6QtHipfooGJzZBH1WioeKiUZAZC2pkuUJRoAMNvzh5RtQBHiRzfrG12e7nzYRl4E1h7kTbXRW1VsZD";e.userAvatar=null,e.userLink=null,e.newAvatar=null,e.graphUserAvatar=function(t){l.api("/"+t+"/picture?height=100&width=100",function(t){t&&!t.error||alert("error!"),e.newAvatar=t.data.url})},e.buyersAvatar=[],firebase.auth().onAuthStateChanged(function(e){e||(window.location="/#/auth")});var A=firebase.database().ref();e.orders=[],e.comments=u(A.child("comments")),e.sources=[],e.statuses=u(A.child("statuses")),e.sellers=u(A.child("members")),e.packs=[],h.getAllOrders().then(function(t){e.orders=t,e.isAsideLoading=!1,e.buyersAvatar=[],angular.forEach(t,function(t,n){l.api("/"+t.fbId+"/picture?height=100&width=100",function(n){t.fbId&&e.buyersAvatar.push({fbId:t.fbId,avatar:n.data.url})})}),h.getAllSources().then(function(t){e.sources=t,h.getAllPacks().then(function(t){e.packs=t,"home.details"==o.current.name&&(w(h.getOrder(a.id)),e.isPageBusy=!1)})})}),e.ordersStatusesForFilter=[],e.ordersStatuses=[],e.statuses.$loaded().then(function(t){e.ordersStatusesForFilter=[],angular.forEach(e.statuses,function(t,n){1==t.active&&1==t.allow_fillter&&e.ordersStatusesForFilter.push(t),1==t.active&&e.ordersStatuses.push(t)})}),e.aaa="https://scontent.fhan3-1.fna.fbcdn.net/v/t1.0-1/p240x240/18581543_1455556341162977_5456006493664399355_n.jpg?oh=59b7c26157bb305b4f7d965dbbe265b6&oe=5A83CAB4",e.updateAvatar=function(){var e=firebase.auth().currentUser;e.updateProfile({displayName:"Cá Cơm",photoURL:"https://scontent.fhan3-1.fna.fbcdn.net/v/t1.0-1/p240x240/18581543_1455556341162977_5456006493664399355_n.jpg?oh=59b7c26157bb305b4f7d965dbbe265b6&oe=5A83CAB4"}).then(function(){console.log("success"),console.log(e)}).catch(function(e){console.log("error")})},e.selectedOrder=null,firebase.database().ref("orders").limitToLast(1).on("child_added",function(t){e.showNotify(t.val()),l.api("/"+t.val().fbId+"/picture?height=100&width=100",function(t){t&&!t.error||alert("error!"),e.$apply(function(){e.newAvatar=t.data.url})})}),e.getBuyerAvatar=function(t){return r("filter")(e.buyersAvatar,{fbId:t.fbId}).avatar},e.defaultToastrConfig=angular.copy(i),e.alertTypes=["success","error","info","warning"],e.showSearchbox=!0,e.isSeaching=!1,e.searchText="",e.isPageBusy=!0,e.isAsideLoading=!0,e.isPostingComment=!1,e.activeStatus=null,e.date=new Date,e.fbContent=null,e.fbPhotos=[],e.currentPageName="",e.currentPageAvatar="",e.dateRange={},e.dateRange.startDate=new Date,e.dateRange.endDate=new Date,e.isPostExpanded=!1,e.child={},e.signOut=function(){firebase.auth().signOut()},e.newDate=function(e){return new Date(e)},e.toggleExpandPost=function(){e.isPostExpanded=!e.isPostExpanded},e.currentUser=null;!function(){var t=[];A.child("members").orderByChild("id").equalTo(73).once("value",function(e){e.forEach(function(e){var n=e.val();t.push(n)})}),e.currentUser=t}(),e.isShowAll=!1,e.showAlert=function(t,n,r){var o={autoDismiss:!1,positionClass:"toast-bottom-center",type:r,timeOut:"3000",extendedTimeOut:"2000",allowHtml:!1,closeButton:!0,tapToDismiss:!0,progressBar:!1,newestOnTop:!0,maxOpened:0,preventDuplicates:!1,preventOpenDuplicates:!1,title:t,msg:n};angular.extend(e.defaultToastrConfig,o),s[o.type](o.msg,o.title,e.defaultToastrConfig)},e.$on("$destroy",function(){angular.extend(i,e.defaultToastrConfig)}),e.showMyOrders=!1,e.toggleShowMyOrders=function(){e.showMyOrders=!e.showMyOrders},e.getOrderByUid=function(t){return e.orders.filter(function(e){return e.id==t})[0]},e.addToFavourite=function(t,n){t.stopPropagation(),n.seller_will_call_id?e.showAlert("","Oops! This Order has belonged to "+e.getSeller(n.seller_will_call_id).last_name,"error"):(n.seller_will_call_id=73,h.updateOrder(n).then(function(e){},function(t){e.showAlert("","Oops! "+t,"error")}),e.getOrderSound.play())},e.userCanReleaseOrChangeStatus=function(e){return!0},e.releaseOrder=function(t,n){if(t.stopPropagation(),!e.userCanReleaseOrChangeStatus)return!1;n.seller_will_call_id=null,h.updateOrder(n).then(function(e){},function(t){e.showAlert("","Oops! "+t,"error")}),e.releaseOrderSound.play()},e.resetSearch=function(){e.searchText=""},e.toggleShowAll=function(){e.activeStatus=null,e.showMyOrders=!1,e.searchText=""},e.toggleActiveStatus=function(t){e.activeStatus!=t?e.activeStatus=t:e.activeStatus=null},e.active=function(e){w(e)},e.findUser=function(t){var n=r("filter")(e.sellers,{id:t},!0);return n.length?n[0]:null},e.getStatusById=function(t){var n=r("filter")(e.statuses,{id:t},!0);return n.length?n[0]:null},e.getOrderStatusForOrder=function(t){if(t)for(var n=0;n<e.statuses.length;n++)if(t.status_id==e.statuses[n].id)return e.statuses[n].display_type},e.filterOrdersByStatus=function(e){firebase.database().ref().child("orders").orderByChild("status_id").equalTo(e.id).once("value",function(e){e.forEach(function(e){e.val()})})},e.commentData={},e.loading=!1,e.submitComment=function(t){if(!e.commentData.content)return!1;var n={id:firebase.database().ref().child("comments").push().key,order_id:t.id,content:e.commentData.content,created_at:Date.now(),type:0,status_id:0,user:e.getSeller(73)};firebase.database().ref().child("comments").push(n),e.commentData={}},e.removeComment=function(t){var n=e.commentList.indexOf(t);e.commentList.splice(n,1)},e.getCommentById=function(t){var n=r("filter")(e.commentList,{id:t},!0);return n.length?n[0]:null},e.deleteComment=function(t){void 0!=t.id&&e.comments.$remove(t)},e.updateStatus=function(t,n,r){if(e.clickSound.play(),!e.userCanReleaseOrChangeStatus(t))return e.showAlert("","Oops! Not allowed to change the order status of others.","error"),!1;var o=angular.element(n.target).attr("data-status-id");t.status_id=o,h.updateOrder(t).then(function(e){},function(t){e.showAlert("","Oops! "+t,"error")});var a={id:firebase.database().ref().child("comments").push().key,order_id:t.id,content:"",created_at:Date.now(),type:1,status_id:r.id,user:e.getSeller(73)};firebase.database().ref().child("comments").push(a),e.commentData={}},e.quickUpdateStatus=function(t){if(!e.selectedOrder)return e.showAlert("","Oops! Please select an Order befor perform this action.","error"),!1;e.changeStatus(e.selectedOrder,t).then(function(n){for(var r=e.orders.length-1;r>=0;r--)e.orders[r].id==e.selectedOrder.id&&(e.orders[r].status_id=t)})},e.toggleShowSearchBox=function(){e.showSearchbox=!e.showSearchbox},n.add({combo:"shift+c",description:"Chốt nhanh đơn hàng",callback:function(){e.quickUpdateStatus(6)}}),n.add({combo:"shift+m",description:"Hiện thông tin cá nhân của tôi",callback:function(){e.child.toggleShowMeExpand()}});e.getSeller=function(e){if(!e)return null;var t=[];return A.child("members").orderByChild("id").equalTo(e).on("value",function(e){e.forEach(function(e){var n=e.val();t.push(n)})}),t[0]},e.clibboardCoppyLink=function(t){var n=o.href(o.current.name,o.params,{absolute:!0});c.copy(n).then(function(){e.showAlert("","Order has been copied. Press Ctrl+V to paste.","info")})},e.showNotify=function(t){e.graphUserAvatar(t.fbId);var n=t&&t.buyer_name?t.buyer_name+t.buyer_mobile:"No name";d.showNotification("New Order Notification",{body:n,icon:e.newAvatar,onClick:function(){e.active(t)},autoClose:5e3},function(e,t){e?window.alert("Unable to show notification: "+e.message):(console.log("Notification Shown."),setTimeout(function(){console.log("Hiding notification...."),t()},5e3))})},e.user={},e.logged=!1,e.byebye=!1,e.salutation=!1,e.$watch(function(){return l.isReady()},function(t){t&&(e.facebookReady=!0)});var S=!1;l.getLoginStatus(function(e){"connected"==e.status&&(S=!0)}),e.IntentLogin=function(){S||e.login()},e.login=function(){l.login(function(t){"connected"==t.status&&(e.logged=!0,e.me())})},e.me=function(){e.IntentLogin(),l.api("/me",function(t){e.$apply(function(){e.user=t})})},e.myAvatar="",e.getMyAvatar=function(){e.me(),console.log(e.user),l.api("/"+e.user.id+"/picture?height=100&width=100",function(t){e.$apply(function(){e.myAvatar=t.data.url,console.log(e.myAvatar)})})},e.logout=function(){l.logout(function(){e.$apply(function(){e.user={},e.logged=!1,console.log("logged out")})})},e.$on("Facebook:statusChange",function(t,n){console.log("Status: ",n),"connected"==n.status?e.$apply(function(){e.salutation=!0,e.byebye=!1}):e.$apply(function(){e.salutation=!1,e.byebye=!0,$timeout(function(){e.byebye=!1},2e3)})})}]),meovn.directive("myEnter",function(){return function(e,t,n){e.isPageBusy=!0,t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.myEnter),e.submitComment(e.selectedOrder),e.isPageBusy=!1}),t.preventDefault())})}}),meovn.filter("my_filter",function(){return function(e,t){return e.filter(function(e){if(t.searchText.length>0)return-1!==e.buyer_mobile.indexOf(t.searchText)||-1!==e.buyer_name.toUpperCase().indexOf(t.searchText.toUpperCase());Date.now(),Date.now();return t.showMyOrders&&t.activeStatus?e.seller_will_call_id==t.currentUser.id&&e.status_id==t.activeStatus.id:t.activeStatus?e.status_id==t.activeStatus.id:t.showMyOrders?e.seller_will_call_id==t.currentUser.id:e.created_at<=Date.now()})}});