var meovn=angular.module("meovn",["ui.router","cfp.hotkeys","ngAnimate","toastr","firebase","facebook","CopyToClipboard","angular-web-notification","720kb.tooltips","highcharts-ng"]).config(["$stateProvider","$locationProvider","$urlRouterProvider","FacebookProvider",function(e,t,n,r){t.hashPrefix(""),n.otherwise("/"),e.state("home",{url:"/",controller:"OrdersController",templateUrl:"/templates/home.html"}).state("home.details",{url:"order/:id/:mobile/seller=:seller",params:{id:null,mobile:null,seller:null},templateUrl:"templates/order-details.html"}).state("auth",{url:"/auth",controller:"AuthController",templateUrl:"/templates/auth.html"});r.init("1085772744867580")}]);meovn.service("firebaseService",["$firebaseArray","$filter",function(e,t){var n=firebase.database().ref();commentsArr=e(n.child("comments")),sourcesArr=e(n.child("sources")),statusesArr=e(n.child("statuses")),membersArr=e(n.child("members")),packsArr=e(n.child("packs"));return{getAllComments:function(){return commentsArr.$loaded()},getCommentForOrder:function(e){var t=[];return n.child("comments").orderByChild("order_id").equalTo(e.id).once("value",function(e){angular.forEach(e.val(),function(e,n){t.push(e)})}),t},addComment:function(e){return commentsArr.$add(e)},updateComment:function(e){return commentsArr.$save(e)},removeComment:function(e){return n.child("comments").orderByChild("id").equalTo(e.id).once("value",function(e){e.forEach(function(e){e.ref.remove()})})},getAllStatuses:function(){return statusesArr.$loaded()},updateOrder:function(e){return n.child("orders").orderByChild("id").equalTo(e.id).once("value",function(t){t.forEach(function(t){t.ref.update({seller_will_call_id:e.seller_will_call_id})})})},updateOrderStatus:function(e){return n.child("orders").orderByChild("id").equalTo(e.id).once("value",function(t){t.forEach(function(t){t.ref.update({status_id:e.status_id})})})},updateOrderSellerWillCall:function(e){return n.child("orders").orderByChild("id").equalTo(e.id).once("value",function(t){t.forEach(function(t){return t.ref.update({seller_will_call_id:e.seller_will_call_id})})})},getAllSources:function(){return sourcesArr.$loaded()},getAllPacks:function(){return packsArr.$loaded()},getAllMembers:function(){return membersArr.$loaded()},getMember:function(e){return membersArr.$getRecord(e)},getMemberByEmail:function(e){membersArr.$loaded().then(function(){return angular.forEach(membersArr,function(t){return t.email==e?t:null}),null})}}}]),meovn.controller("AuthController",["$scope","$http","hotkeys","$filter","toastr","toastrConfig","$firebaseArray","Facebook","$copyToClipboard","webNotification","$state",function(e,t,n,r,o,a,i,s,l,c,u){e.email="",e.password="";document.getElementById("btnSignin");var d=firebase.auth();e.signIn=function(t){t.preventDefault(),d.signInWithEmailAndPassword(e.email,e.password).catch(console.log(t.message))},firebase.auth().onAuthStateChanged(function(e){e&&u.go("home")})}]),meovn.controller("MembersController",["$scope","$http","$filter","$window",function(e,t,n,r){e.showPasswordEditBox=!1,e.showMeExpand=!1,e.$parent.child=e,e.toggleShowPasswordEditBox=function(){e.showPasswordEditBox=!e.showPasswordEditBox},e.toggleShowMeExpand=function(){e.showMeExpand=!e.showMeExpand},e.submitPassword=function(t,n){e.changePassword(t,n).then(function(t){e.showPasswordEditBox=!1,r.location.href="/logout"})},e.changePassword=function(e,n){if(e){var r=$("input.newPassword").val();if(!(r.length<8)){var o="v3/changePassword/"+e.id;return t.post(o,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:r})}alert("Nhập mật khẩu tổi thiểu 8 ký tự!")}}}]),meovn.controller("OrdersController",["$scope","$http","$timeout","hotkeys","$filter","$state","$stateParams","toastr","toastrConfig","$firebaseArray","Facebook","$copyToClipboard","webNotification","firebaseService",function(e,t,n,r,o,a,i,s,l,c,u,d,h,f){function m(t){e.isPageBusy=!0,u.api("/"+t+"?access_token="+A,function(t){e.currentPageName=t.name}),u.api("/"+t+"/picture?access_token="+A,function(t){e.currentPageAvatar=t.data.url}).then(function(){e.isPageBusy=!1})}function g(t){u.api("/"+t+"/picture?height=100&width=100",function(t){e.userAvatar=t.data.url})}function p(t,n){e.isPageBusy=!0,u.api("/"+t+"_"+n+"?access_token="+A,function(t){e.fbContent=t}).then(function(){e.isPageBusy=!1}),u.api("/"+t+"_"+n+"/attachments?access_token="+A,function(t){e.fbPhotos=[];for(var n=0;n<t.data[0].subattachments.data.length-1;n++)e.fbPhotos.push(t.data[0].subattachments.data[n].media.image.src)}).then(function(){e.isPageBusy=!1})}function b(t){var n=o("filter")(e.sources,{id:t.order_source_id},!0);return n.length?n[0].page_id:null}function v(t){var n=o("filter")(e.packs,{id:t.product_pack_id},!0);return n.length?n[0].post_id:null}function y(t){e.isPageBusy=!0,e.isPostExpanded=!1,g(t.fbId),e.fbContent=[],e.fbContent.message="",e.fbPhotos=[],e.currentPageName="",e.currentPageAvatar="",m(b(t)),p(b(t),v(t)),e.selectedOrder=t,e.comments=f.getCommentForOrder(t)}function w(t){e.graphUserAvatar(t.fbId);var n=t&&t.buyer_name?t.buyer_name+"/"+t.buyer_mobile:"No name";h.showNotification("Newest Order!",{body:n,icon:e.newAvatar,onClick:function(){e.active(t)},autoClose:5e3},function(e,t){e?window.alert("Unable to show notification: "+e.message):setTimeout(function(){t()},5e3)})}function C(t){t||(t=2);var n=new Date,r=new Date;r.setDate(r.getDate()-t),n.setDate(n.getDate()),r=r.getTime(),n=n.getTime(),_.child("orders").orderByChild("created_at").startAt(r).endAt(n).once("value",function(t){var n=[];t.forEach(function(e){n.push(e.val())}),e.tt=n.reverse()})}function S(t){return t.content=e.requestContent,!(t.content.length<3)}var A="EAAPbgSrDvvwBAE83TW0ZCCm83YuFXjaQmyd7UQZC9hHhaumkN8aiscrr0hxvlRZAeVae7HDpY1vv3aIzPZAH3O6QtHipfooGJzZBH1WioeKiUZAZC2pkuUJRoAMNvzh5RtQBHiRzfrG12e7nzYRl4E1h7kTbXRW1VsZD";e.userAvatar=null,e.userLink=null,e.newAvatar=null,e.graphUserAvatar=function(t){u.api("/"+t+"/picture?height=100&width=100",function(t){t&&!t.error||alert("error!"),e.newAvatar=t.data.url})},e.buyersAvatar=[],f.getAllSources().then(function(t){e.sources=t,f.getAllPacks().then(function(t){e.packs=t,"home.details"==a.current.name&&(e.pleaseWaitMessage="Loading Order details. Please wait...",angular.forEach(e.tt,function(t,n){t.id===i.id&&y(e.tt[n])}),e.isPageBusy=!1),e.isAsideLoading=!1})}),e.currentMember=null,firebase.auth().onAuthStateChanged(function(t){t?(e.firebaseUser=firebase.auth().currentUser,f.getAllMembers().then(function(t){e.sellers=t,angular.forEach(e.sellers,function(t){t.email==e.firebaseUser.email&&(e.currentMember=t)})})):a.go("auth")});var _=firebase.database().ref();e.orders=[],e.comments=[],e.sources=[],e.statuses=[],e.sellers=[],e.packs=[],e.ordersStatusesForFilter=[],e.ordersStatuses=[],f.getAllStatuses().then(function(t){e.statuses=t,e.ordersStatusesForFilter=[],angular.forEach(e.statuses,function(t,n){1==t.active&&1==t.allow_fillter&&e.ordersStatusesForFilter.push(t),1==t.active&&e.ordersStatuses.push(t)})}),e.updateFirebaseUser=function(e,t){var n=firebase.auth().currentUser;n.updateProfile({displayName:t,photoURL:e}).then(function(){console.log("success"),console.log(n)}).catch(function(e){console.log("error")})},firebase.database().ref("orders").limitToLast(1).on("child_added",function(t){e.tt.unshift(t.val()),w(t.val()),u.api("/"+t.val().fbId+"/picture?height=100&width=100",function(t){t&&!t.error||alert("error!"),e.newAvatar=t.data.url})}),e.getBuyerAvatar=function(t){return o("filter")(e.buyersAvatar,{fbId:t.fbId}).avatar},e.defaultToastrConfig=angular.copy(l),e.alertTypes=["success","error","info","warning"],e.showSearchbox=!0,e.isSeaching=!1,e.searchText="",e.isPageBusy=!0,e.isAsideLoading=!0,e.isPostingComment=!1,e.activeStatus=null,e.date=new Date,e.fbContent=null,e.fbPhotos=[],e.currentPageName="",e.currentPageAvatar="",e.dateRange={},e.dateRange.startDate=new Date,e.dateRange.endDate=new Date,e.isPostExpanded=!1,e.selectedOrder=null,e.child={},e.signOut=function(){firebase.auth().signOut()},e.newDate=function(e){return new Date(e)},e.toggleExpandPost=function(){e.isPostExpanded=!e.isPostExpanded},e.isShowAll=!1,e.showAlert=function(t,n,r){var o={autoDismiss:!1,positionClass:"toast-bottom-center",type:r,timeOut:"3000",extendedTimeOut:"2000",allowHtml:!1,closeButton:!0,tapToDismiss:!0,progressBar:!1,newestOnTop:!0,maxOpened:0,preventDuplicates:!1,preventOpenDuplicates:!1,title:t,msg:n};angular.extend(e.defaultToastrConfig,o),s[o.type](o.msg,o.title,e.defaultToastrConfig)},e.$on("$destroy",function(){angular.extend(l,e.defaultToastrConfig)}),e.showMyOrders=!1,e.toggleShowMyOrders=function(){e.showMyOrders=!e.showMyOrders},e.getOrderByUid=function(t){return e.orders.filter(function(e){return e.id==t})[0]},e.addToFavourite=function(t,n){t.stopPropagation(),n.seller_will_call_id?e.showAlert("","Oops! This Order has belonged to "+e.getSeller(n.seller_will_call_id).last_name,"error"):(n.seller_will_call_id=e.currentMember.id,f.updateOrderSellerWillCall(n))},e.userCanReleaseOrChangeStatus=function(t){return e.currentMember?1==e.currentMember.is_admin||e.currentMember.id==t.seller_will_call_id:null},e.releaseOrder=function(t,n){if(t.stopPropagation(),!e.userCanReleaseOrChangeStatus)return!1;n.seller_will_call_id=null,f.updateOrderSellerWillCall(n)},e.resetSearch=function(){e.searchText=""},e.toggleShowAll=function(){e.activeStatus=null,e.showMyOrders=!1,e.searchText=""},e.toggleActiveStatus=function(t){e.activeStatus!=t?e.activeStatus=t:e.activeStatus=null},e.pleaseWaitMessage="Select an order to display",e.active=function(e){y(e)},e.findUser=function(t){var n=o("filter")(e.sellers,{id:t},!0);return n.length?n[0]:null},e.getStatusById=function(t){var n=o("filter")(e.statuses,{id:t},!0);return n.length?n[0]:null},e.getOrderStatusForOrder=function(t){if(t)for(var n=0;n<e.statuses.length;n++)if(t.status_id==e.statuses[n].id)return e.statuses[n].display_type},e.commentData={},e.loading=!1,e.submitComment=function(t){if(!e.commentData.content)return!1;var n={id:firebase.database().ref().child("comments").push().key,order_id:t.id,content:e.commentData.content,created_at:Date.now(),type:0,status_id:0,user:e.currentMember};f.addComment(n).then(function(t){e.comments.push(n)},function(t){e.showAlert("","Oops! "+t,"error")}),e.commentData={}},e.removeComment=function(t){var n=e.commentList.indexOf(t);e.commentList.splice(n,1)},e.getCommentById=function(t){var n=o("filter")(e.commentList,{id:t},!0);return n.length?n[0]:null},e.deleteComment=function(t){void 0!=t.id&&f.removeComment(t).then(function(e){},function(t){e.showAlert("","Oops! "+t,"error")})},e.updateStatus=function(t,n,r){if(!e.userCanReleaseOrChangeStatus(t))return e.showAlert("","Oops! Not allowed to change the order status of others.","error"),!1;t.status_id=r.id,f.updateOrderStatus(t);var o={id:firebase.database().ref().child("comments").push().key,order_id:t.id,content:"",created_at:Date.now(),type:1,status_id:r.id,user:e.currentMember};f.addComment(o).then(function(t){e.comments.push(o)},function(t){e.showAlert("","Oops! "+t,"error")}),e.commentData={}},e.quickUpdateStatus=function(t){if(!e.selectedOrder)return e.showAlert("","Oops! Please select an Order befor perform this action.","error"),!1;e.changeStatus(e.selectedOrder,t).then(function(n){for(var r=e.orders.length-1;r>=0;r--)e.orders[r].id==e.selectedOrder.id&&(e.orders[r].status_id=t)})},e.toggleShowSearchBox=function(){e.showSearchbox=!e.showSearchbox},r.add({combo:"shift+c",description:"Chốt nhanh đơn hàng",callback:function(){e.quickUpdateStatus(6)}}),r.add({combo:"shift+m",description:"Hiện thông tin cá nhân của tôi",callback:function(){e.toggleShowMeExpand()}}),e.showMeExpand=!1,e.toggleShowMeExpand=function(){e.showMeExpand=!e.showMeExpand,e.showMeExpand&&e.initChart()},r.add({combo:"esc",description:"Thoát",callback:function(){e.hideAllModals()}}),e.getSeller=function(e){if(!e)return null;var t=[];return _.child("members").orderByChild("id").equalTo(e).once("value",function(e){e.forEach(function(e){var n=e.val();t.push(n)})}),t[0]},e.clibboardCoppyLink=function(t){var n=a.href(a.current.name,a.params,{absolute:!0});d.copy(n).then(function(){e.showAlert("","Order has been copied. Press Ctrl+V to paste.","info")})},e.user={},e.logged=!1,e.byebye=!1,e.salutation=!1,e.$watch(function(){return u.isReady()},function(t){t&&(e.facebookReady=!0)});var D=!1;u.getLoginStatus(function(e){"connected"==e.status&&(D=!0)}),e.IntentLogin=function(){D||e.login()},e.login=function(){u.login(function(t){"connected"==t.status&&(e.logged=!0)})},e.me=function(){u.api("/me",function(t){e.$apply(function(){e.user=t})})},e.myAvatar="",e.getMyAvatar=function(){e.IntentLogin(),u.api("/"+e.user.id+"/picture?height=100&width=100",function(t){e.$apply(function(){e.myAvatar=t.data.url})})},e.logout=function(){u.logout(function(){e.$apply(function(){e.user={},e.logged=!1,console.log("logged out")})})},e.$on("Facebook:statusChange",function(t,r){"connected"==r.status?e.$apply(function(){e.salutation=!0,e.byebye=!1}):e.$apply(function(){e.getMyAvatar(),e.salutation=!1,e.byebye=!0,n(function(){e.byebye=!1},2e3)})});e.chartTypes=[{id:"line",title:"Line"},{id:"spline",title:"Smooth line"},{id:"area",title:"Area"},{id:"areaspline",title:"Smooth area"},{id:"column",title:"Column"},{id:"bar",title:"Bar"},{id:"pie",title:"Pie"},{id:"scatter",title:"Scatter"}],e.dashStyles=[{id:"Solid",title:"Solid"},{id:"ShortDash",title:"ShortDash"},{id:"ShortDot",title:"ShortDot"},{id:"ShortDashDot",title:"ShortDashDot"},{id:"ShortDashDotDot",title:"ShortDashDotDot"},{id:"Dot",title:"Dot"},{id:"Dash",title:"Dash"},{id:"LongDash",title:"LongDash"},{id:"DashDot",title:"DashDot"},{id:"LongDashDot",title:"LongDashDot"},{id:"LongDashDotDot",title:"LongDashDotDot"}];var P=[{name:"Đã gọi",data:[80,115,46,72,39,55,80],id:"s1",dashStyle:"ShortDash",color:"#888",lineWidthPlus:"1",lineWidth:"1"},{name:"Đã chốt",data:[25,50,30,10,55,66,78],color:"#8bbc21",borderColor:"#8bbc21",type:"column",id:"s3"},{name:"Thất bại",data:[14,16,18,11,22,45,23],color:"rgb(170,25,25)",borderColor:"rgb(170,25,25)",type:"column",id:"s4"},{name:"Báo xấu",data:[9,15,25,1,22,10,8],color:"rgb(38,60,83)",borderColor:"rgb(38,60,83)",type:"column",id:"s5"},{name:"Khác",data:[25,35,18,9,20,11,15],color:"rgb(72,151,241)",borderColor:"rgb(72,151,241)",type:"column",id:"s6"}];e.chartSeries=[],e.initChart=function(){for(var t=P.length-1;t>=0;t--)e.chartConfig.series.push(P[t])},e.tt=[],e.testChangeData=function(){e.chartConfig.series[0].data=[70,15,56,82,49,65,88];for(var t=[],n=0;n<7;n++)t.push(Math.floor(20*Math.random())+1);e.chartConfig.series[0].data=t,C(2),console.log(e.tt)},e.currentOrder=null,C(10),_.child("orders").limitToLast(1).on("child_added",function(t){e.tt.unshift(t.val())}),_.child("orders").on("child_changed",function(t){angular.forEach(e.tt,function(r,o){r.id!==t.val().id||n(function(){angular.copy(t.val(),e.tt[o]),e.$apply()},10)})}),e.addSeries=function(){for(var t=[],n=0;n<10;n++)t.push(Math.floor(20*Math.random())+1);var r="__series"+O++;e.chartConfig.series.push({data:t,id:r})},e.chartStack=[{id:"",title:"No"},{id:"normal",title:"Normal"},{id:"percent",title:"Percent"}],e.addPoints=function(){var t=e.chartConfig.series,n=Math.floor(Math.random()*t.length);t[n].data=t[n].data.concat([1,10,20])};var O=0,k=0,$=0;e.addAxis=function(t){var n,r;"y"===t?(n=k+=1,r="yAxis"):(n=$+=1,r="xAxis");for(var o=[],a=0;a<10;a++)o.push(Math.floor(20*Math.random())+1);e.chartConfig[r]||(e.chartConfig[r]=[]),e.chartConfig[r].push({min:Math.min.apply(null,o),max:Math.max.apply(null,o),title:{text:t+"-Axis"+n.toString()},id:t+"Axis_"+n})},e.removeRandomSeries=function(){var t=e.chartConfig.series,n=Math.floor(Math.random()*t.length);t.splice(n,1)},e.removeSeries=function(t){e.chartConfig.series.splice(t,1)},e.toggleHighCharts=function(){this.chartConfig.useHighStocks=!this.chartConfig.useHighStocks},e.replaceAllSeries=function(){e.chartConfig.series=[{name:"first",data:[10],id:"a"},{name:"second",data:[3],id:"b"},{name:"third",data:[13],id:"c"}]},e.chartConfig={chart:{height:500,width:600,type:"line"},plotOptions:{series:{stacking:"",states:{hover:{lineWidthPlus:1,lineWidth:1}},dataLabels:{enabled:!0,crop:!1,overflow:"none",style:{fontWeight:"300",color:"#FFFFFF"}}}},series:e.chartSeries,title:{text:"My Data in recent 7 days",style:{color:"#fff",fontWeight:"300",fontSize:"24px"}},yAxis:{gridLineColor:"#393939",labels:{style:{color:"#fff"}}},xAxis:{categories:["25/10","26/10","27/10","28/10","29/10","30/10","31/10"],gridLineColor:"#393939",labels:{style:{color:"#fff"}}}},e.reflow=function(){e.$broadcast("highchartsng.reflow")},e.quickComments=["Khách hẹn gọi lại vào lúc ...","Khách yêu cầu gửi ...","Khách đang bận, gọi lại sau ..","Khách bận, mai gọi lại"],e.selectQuickComment=function(t){t&&(e.commentData.content=t,e.showQuickComment=!1)},e.showQuickComment=!1,e.toggleShowQuickComment=function(){e.showQuickComment=!e.showQuickComment},e.hideQuickComment=function(){e.showQuickComment=!1},e.clearCommentData=function(){e.commentData.content=""},e.isShowOverlay=!1,e.isShowHelpPanel=!1,e.showHelpPanel=function(){e.isShowHelpPanel=!0,e.isShowOverlay=!0},e.closeHelpPanel=function(){e.isShowHelpPanel=!1,e.isShowOverlay=!1},e.hideAllModals=function(){e.isShowHelpPanel&&e.closeHelpPanel()};e.requests=[],e.requestContent="";var x={fromSeller:"73",created_at:null,type:"1",status:"1",forOrder:"xxx",content:"",response:""};e.submitRequest=function(){S(x)&&(x.created_at=new Date,e.requests.push(x))}}]),meovn.controller("SupportController",["$scope","$http","hotkeys","$filter","$firebaseArray",function(e,t,n,r,o){}]),meovn.directive("myEnter",function(){return function(e,t,n){e.isPageBusy=!0,t.bind("keydown keypress",function(t){13===t.which?(e.$apply(function(){e.$eval(n.myEnter),e.submitComment(e.selectedOrder),e.isPageBusy=!1}),t.preventDefault()):27===t.which&&e.$apply(function(){e.$eval(n.myEnter),e.clearCommentData()})})}}),meovn.directive("requestEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which?(e.$apply(function(){e.$eval(n.requestEnter),e.submitRequest(),e.isPageBusy=!1}),t.preventDefault()):27===t.which&&e.$apply(function(){e.$eval(n.requestEnter),e.requestContent=""})})}}),meovn.directive("clickOutside",["$document",function(e){return{restrict:"A",scope:{clickOutside:"&"},link:function(t,n,r){e.on("click",function(e){n===e.target||n[0].contains(e.target)||t.$apply(function(){t.$eval(t.clickOutside)})})}}}]),meovn.filter("my_filter",function(){return function(e,t){return e.filter(function(e){return t.searchText.length>0?-1!==e.buyer_mobile.indexOf(t.searchText)||-1!==e.buyer_name.toUpperCase().indexOf(t.searchText.toUpperCase()):t.showMyOrders&&t.activeStatus?e.seller_will_call_id==t.currentMember.id&&e.status_id==t.activeStatus.id:t.activeStatus?e.status_id==t.activeStatus.id:t.showMyOrders?e.seller_will_call_id==t.currentMember.id:e})}});